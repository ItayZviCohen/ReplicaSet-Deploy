---

- name: Deploy a MongoDB ReplicaSet on k8s
  hosts: localhost
  tasks:
    - name: Validate Ops Manager and k8s api server urls
      assert:
        that:
          - "{{ item.condition }}"
        fail_msg: "{{ item.msg }}"
        quiet: true
      loop:
        - { condition: "ops_manager_url is match('^https?://.*$')", msg: "Ops Manager's URL is not a valid one!" }
        - { condition: "k8s_api_url is regex('^https?://.*$')", msg: "The kubernetes api's URL is not a valid one!" }
    - name: Check if the namespace already has an Ops Manager user
      k8s_info:
        host: "{{ k8s_api_url }}"
        api_version: v1
        kind: Secret
        name: organization-details
        namespace: "{{ k8s_namespace }}"
      register: operator_organization_details
    - name: Create an Ops Manager user and save its info in the namespace
      include_tasks: create_org.yml
      when: "(operator_organization_details.resources | length) == 0"
